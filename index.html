<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        #global-summary {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #global-summary h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.2em;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .summary-item {
            text-align: left;
        }
        .summary-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        #table-container {
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            background-color: #f4f4f4;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .loading {
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
            padding: 20px;
        }
        .positive {
            color: #2e7d32;
            font-weight: bold;
        }
        .negative {
            color: #c62828;
            font-weight: bold;
        }
        .coin-name {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Crypto Market Dashboard</h1>
    
    <!-- Global Market Summary Header -->
    <div id="global-summary">
        <h2>Global Market Summary</h2>
        <div id="global-content" class="loading">Loading global metrics...</div>
    </div>
    
    <!-- Coin Table -->
    <div id="table-container">
        <div id="content" class="loading">Loading coin data...</div>
    </div>

    <script>
        // Backend API endpoint URLs
        // These point to the FastAPI server running on localhost:8000
        const COINS_API_URL = 'http://localhost:8000/api/coins';
        const GLOBAL_API_URL = 'http://localhost:8000/api/global';
        
        // Get references to the DOM elements
        const contentDiv = document.getElementById('content');
        const globalContentDiv = document.getElementById('global-content');
        
        // Function to format a number as currency (USD)
        // Takes a number and returns a formatted string like "$45,000.50"
        function formatCurrency(value) {
            // toLocaleString() formats numbers with locale-specific formatting
            // 'en-US' specifies US format, style: 'currency' adds $ symbol
            return value.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        // Function to format a percentage value
        // Takes a number and returns a formatted string like "2.50%"
        function formatPercent(value) {
            // toFixed(2) rounds to 2 decimal places
            // Add the % symbol at the end
            return value.toFixed(2) + '%';
        }
        
        // Function to format a large number (for volume)
        // Takes a number and returns a formatted string like "$25,000,000,000"
        function formatVolume(value) {
            // Use toLocaleString() to add commas for readability
            // Then add $ symbol manually since we're not using currency style
            return '$' + value.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        // Function to format large numbers with abbreviations (B for billions, T for trillions)
        // Takes a number and returns a formatted string like "$1.2T" or "$950B"
        function formatLargeNumber(value) {
            // 1 trillion = 1,000,000,000,000
            // If value is >= 1 trillion, divide by 1 trillion and add "T"
            if (value >= 1000000000000) {
                const trillions = value / 1000000000000;
                // toFixed(1) rounds to 1 decimal place
                return '$' + trillions.toFixed(1) + 'T';
            }
            // 1 billion = 1,000,000,000
            // If value is >= 1 billion, divide by 1 billion and add "B"
            else if (value >= 1000000000) {
                const billions = value / 1000000000;
                // toFixed(1) rounds to 1 decimal place
                return '$' + billions.toFixed(1) + 'B';
            }
            // For values less than 1 billion, use regular formatting with commas
            else {
                return '$' + value.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
        }
        
        // Function to fetch and display global market metrics
        async function fetchGlobalMetrics() {
            try {
                // fetch() makes an HTTP GET request to the global metrics endpoint
                // await pauses execution until the Promise resolves
                const response = await fetch(GLOBAL_API_URL);
                
                // Check if the HTTP response status is OK (200-299)
                if (!response.ok) {
                    // Parse error response and throw an error
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch global metrics');
                }
                
                // Parse the JSON response
                // The backend returns: {total_market_cap_usd: 2000000000000, total_volume_24h_usd: 80000000000, btc_dominance_percent: 45.5}
                const globalData = await response.json();
                
                // Build the HTML for the global summary
                // Create a grid layout with 3 items
                let summaryHTML = '<div class="summary-grid">';
                
                // Total Market Cap item
                summaryHTML += '<div class="summary-item">';
                summaryHTML += '<div class="summary-label">Total Market Cap</div>';
                // formatLargeNumber() formats the value with abbreviation (e.g., "$1.2T")
                summaryHTML += `<div class="summary-value">${formatLargeNumber(globalData.total_market_cap_usd)}</div>`;
                summaryHTML += '</div>';
                
                // Total 24h Volume item
                summaryHTML += '<div class="summary-item">';
                summaryHTML += '<div class="summary-label">Total 24h Volume</div>';
                // formatLargeNumber() formats the value with abbreviation (e.g., "$950B")
                summaryHTML += `<div class="summary-value">${formatLargeNumber(globalData.total_volume_24h_usd)}</div>`;
                summaryHTML += '</div>';
                
                // Bitcoin Dominance item
                summaryHTML += '<div class="summary-item">';
                summaryHTML += '<div class="summary-label">Bitcoin Dominance</div>';
                // formatPercent() formats the percentage (e.g., "48.3%")
                summaryHTML += `<div class="summary-value">${formatPercent(globalData.btc_dominance_percent)}</div>`;
                summaryHTML += '</div>';
                
                summaryHTML += '</div>';
                
                // Update the global content div with the summary HTML
                globalContentDiv.className = ''; // Remove loading class
                globalContentDiv.innerHTML = summaryHTML;
                
            } catch (error) {
                // Handle errors independently - show error in global summary area
                // This doesn't affect the coin table
                globalContentDiv.className = 'error'; // Add error styling
                globalContentDiv.innerHTML = `Error: ${error.message}`;
            }
        }
        
        // Function to fetch and display multiple coins
        async function fetchCoins() {
            try {
                // fetch() is a modern JavaScript function for making HTTP requests
                // It returns a Promise that resolves to a Response object
                // await pauses execution until the Promise resolves
                const response = await fetch(COINS_API_URL);
                
                // Check if the HTTP response status is OK (200-299)
                // If not OK, the request failed (e.g., 502 error from backend)
                if (!response.ok) {
                    // response.json() parses the error response body as JSON
                    // await waits for the JSON parsing to complete
                    const errorData = await response.json();
                    // Throw an error with the error message from the backend
                    throw new Error(errorData.detail || 'Failed to fetch coin data');
                }
                
                // If response is OK, parse the JSON body
                // The backend returns an array: [{id: "bitcoin", name: "Bitcoin", price_usd: 45000.50, ...}, ...]
                // await waits for JSON parsing to complete
                const coins = await response.json();
                
                // Check if coins is an array and has data
                if (!Array.isArray(coins) || coins.length === 0) {
                    throw new Error('No coin data received');
                }
                
                // Build the HTML table structure
                // Start with the table header row
                let tableHTML = '<table><thead><tr>';
                tableHTML += '<th>Coin Name</th>';
                tableHTML += '<th>Price (USD)</th>';
                tableHTML += '<th>24h Change (%)</th>';
                tableHTML += '<th>24h Volume (USD)</th>';
                tableHTML += '</tr></thead><tbody>';
                
                // Iterate through each coin in the array
                // coins.forEach() loops through each coin object
                coins.forEach(function(coin) {
                    // Start a new table row for this coin
                    tableHTML += '<tr>';
                    
                    // Coin Name column
                    // coin.name contains the full name (e.g., "Bitcoin")
                    tableHTML += `<td class="coin-name">${coin.name}</td>`;
                    
                    // Price column
                    // coin.price_usd contains the numeric price
                    // formatCurrency() formats it as "$45,000.50"
                    tableHTML += `<td>${formatCurrency(coin.price_usd)}</td>`;
                    
                    // 24h Change column
                    // coin.change_24h contains the percentage change (e.g., 2.5 or -1.2)
                    const change24h = coin.change_24h;
                    // Determine if the change is positive or negative
                    const changeClass = change24h >= 0 ? 'positive' : 'negative';
                    // Format the percentage and apply color class
                    // If positive, class="positive" (green), if negative, class="negative" (red)
                    tableHTML += `<td class="${changeClass}">${formatPercent(change24h)}</td>`;
                    
                    // 24h Volume column
                    // coin.volume_24h_usd contains the volume in USD
                    // formatVolume() formats it as "$25,000,000,000"
                    tableHTML += `<td>${formatVolume(coin.volume_24h_usd)}</td>`;
                    
                    // Close the table row
                    tableHTML += '</tr>';
                });
                
                // Close the table body and table tags
                tableHTML += '</tbody></table>';
                
                // Update the content div with the table HTML
                // innerHTML replaces the content of the div
                contentDiv.className = ''; // Remove loading class
                contentDiv.innerHTML = tableHTML;
                
            } catch (error) {
                // catch block handles any errors that occur in the try block
                // This includes network errors, JSON parsing errors, or thrown errors
                
                // Update the content div to show the error message
                contentDiv.className = 'error'; // Add error styling
                contentDiv.innerHTML = `Error: ${error.message}`;
            }
        }
        
        // Call both fetch functions when the page loads
        // They run independently - if one fails, the other can still succeed
        // window.addEventListener waits for the 'load' event (page fully loaded)
        window.addEventListener('load', function() {
            fetchGlobalMetrics(); // Fetch global metrics
            fetchCoins(); // Fetch coin data
        });
    </script>
</body>
</html>
